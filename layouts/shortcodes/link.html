{{- $target := or (.Get "link") (.Get "path") -}}
{{- $cover := .Get "cover" -}}
{{- $escape := .Get "escape" | default true -}}
{{- $titleParam := .Get "title" -}}

{{- if not $target -}}
	{{- errorf "link shortcode: link/path parameter is required" -}}
{{- end -}}

{{- $protocolPattern := `^(?:https?://|mailto:|tel:)` -}}
{{- $isExternal := gt (len (findRE $protocolPattern $target)) 0 -}}

{{- $href := "" -}}
{{- $title := "" -}}
{{- $excerpt := "" -}}

{{- if $isExternal -}}
	{{- if not $titleParam -}}
		{{- errorf "link shortcode: title is required for external links" -}}
	{{- end -}}
	{{- $title = $titleParam -}}
	{{- $href = $target -}}
	{{- $excerpt = (printf `<span class="icon-link"></span>%s` $target) | safeHTML -}}
{{- else -}}
	{{- $page := .Site.GetPage $target -}}
	{{- if not $page -}}
		{{- errorf "link shortcode: page not found: %s" $target -}}
	{{- end -}}
	{{- $title = $page.Title -}}
	{{- $href = $page.Permalink | relURL -}}
	{{- if $page.Params.description -}}
		{{- $excerpt = $page.Params.description | plainify | truncate 100 -}}
	{{- else if $page.Summary -}}
		{{- $excerpt = $page.Summary | plainify | truncate 100 -}}
	{{- else -}}
		{{- $excerpt = $page.RawContent | truncate 100 -}}
	{{- end -}}
{{- end -}}

{{- $displayTitle := $title -}}
{{- if not $escape -}}
	{{- $displayTitle = $title | safeHTML -}}
{{- end -}}

{{- /* 图片处理：仅对 weibo.com/bilibili.com 使用 i0.wp.com 代理（无排除名单） */ -}}
{{- $coverURL := "" -}}
{{- $fallbackCover := .Site.Params.fallbackCover | default "/images/fallback-cover.png" | relURL -}}
{{- /* 正确获取短代码传入的 title 参数，保留兜底逻辑，避免报错 */ -}}
{{- $title := .Get "title" | default (.Page.Title | default "Default Title") }}
{{- $altText := i18n "cover.alt" (dict "Title" $title) | default $title -}}
{{- /* 获取短代码传入的 cover 参数 */ -}}
{{- $cover := .Get "cover" -}}

{{- if $cover -}}
    {{- if hasPrefix $cover "http" -}}
        {{- /* 正确：使用 slice 函数定义域名白名单（可遍历） */ -}}
        {{- $proxyDomains := slice "weibo.com" "bilibili.com" "hdslb.com" "sinaimg.cn" -}}
        {{- $needProxy := false -}}

        {{- /* 仅判断是否在白名单内，无排除逻辑，简化判断流程 */ -}}
        {{- range $proxyDomains -}}
            {{- if in $cover . -}}
                {{- $needProxy = true -}}
            {{- end -}}
        {{- end -}}

        {{- if $needProxy -}}
            {{- /* 白名单内域名：使用 https://i0.wp.com/ 代理（符合你的要求） */ -}}
            {{- $encodedURL := $cover | replaceRE "^https?://" "" -}}
            {{- $coverURL = printf "https://i0.wp.com/%s" $encodedURL -}}
        {{- else -}}
            {{- /* 非白名单外部链接：直接使用原链接，不代理 */ -}}
            {{- $coverURL = $cover -}}
        {{- end -}}
    {{- else -}}
        {{- /* 本地图片：直接使用相对路径 */ -}}
        {{- $coverURL = $cover | relURL -}}
    {{- end -}}
{{- else -}}
    {{- /* 无封面时，使用备用封面 */ -}}
    {{- $coverURL = $fallbackCover -}}
{{- end -}}

<div class="post-link-card-wrap">
	<div class="post-link-card">
		<a
			href="{{ $href }}"
			title="{{ $title }}"
			{{- if $isExternal -}} rel="noopener nofollow noreferrer" target="_blank"{{- end -}}
		></a>
		{{- if eq $cover "auto" -}}
			{{- if $isExternal -}}
				<div class="post-link-card-cover-wrap auto">
					<div class="icon-globe"></div>
				</div>
			{{- else -}}
				<div class="post-link-card-cover-wrap">
					<img
						src="{{ .Site.Params.banner | relURL }}"
						class="no-lightbox"
						title="{{ $title }}"
						alt="{{ $altText }}"
					/>
				</div>
			{{- end -}}
		{{- else if $cover -}}
			<div class="post-link-card-cover-wrap">
				<img
					src="{{ $coverURL }}"  {{/* <-- 关键修正：使用处理过的 $coverURL */}}
					class="no-lightbox"
					title="{{ $title }}"
					alt="{{ $altText }}"
					loading="lazy"
					{{- /* 加载失败时，显示本地占位图 */ -}}
					onerror="this.onerror=null; this.src='{{ $fallbackCover }}';"
				/>
			</div>
		{{- end -}}
		<div class="post-link-card-item-wrap">
			<div class="post-link-card-title">{{ $displayTitle }}</div>
			<div class="post-link-card-excerpt">
				{{- $excerpt -}}
			</div>
		</div>
	</div>
</div>

