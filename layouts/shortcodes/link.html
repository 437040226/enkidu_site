{{- $target := or (.Get "link") (.Get "path") -}}
{{- $cover := .Get "cover" -}}
{{- $escape := .Get "escape" | default true -}}
{{- $titleParam := .Get "title" -}}

{{- if not $target -}}
	{{- errorf "link shortcode: link/path parameter is required" -}}
{{- end -}}

{{- $protocolPattern := `^(?:https?://|mailto:|tel:)` -}}
{{- $isExternal := gt (len (findRE $protocolPattern $target)) 0 -}}

{{- $href := "" -}}
{{- $title := "" -}}
{{- $excerpt := "" -}}

{{- if $isExternal -}}
	{{- if not $titleParam -}}
		{{- errorf "link shortcode: title is required for external links" -}}
	{{- end -}}
	{{- $title = $titleParam -}}
	{{- $href = $target -}}
	{{- $excerpt = (printf `<span class="icon-link"></span>%s` $target) | safeHTML -}}
{{- else -}}
	{{- $page := .Site.GetPage $target -}}
	{{- if not $page -}}
		{{- errorf "link shortcode: page not found: %s" $target -}}
	{{- end -}}
	{{- $title = $page.Title -}}
	{{- $href = $page.Permalink | relURL -}}
	{{- if $page.Params.description -}}
		{{- $excerpt = $page.Params.description | plainify | truncate 100 -}}
	{{- else if $page.Summary -}}
		{{- $excerpt = $page.Summary | plainify | truncate 100 -}}
	{{- else -}}
		{{- $excerpt = $page.RawContent | truncate 100 -}}
	{{- end -}}
{{- end -}}

{{- $displayTitle := $title -}}
{{- if not $escape -}}
	{{- $displayTitle = $title | safeHTML -}}
{{- end -}}

{{- /* 图片处理：智能选择加载策略以兼容不同网站的防盗链 */ -}}
{{- $coverURL := "" -}}
{{- $fallbackCover := .Site.Params.fallbackCover | default "/images/fallback-cover.png" | relURL -}}
{{- $altText := i18n "cover.alt" (dict "Title" $title) | default $title -}}

{{- if $cover -}}
    {{- if hasPrefix $cover "http" -}}
        {{- /* 统一使用 weserv.nl 代理所有外部图片，以防止防盗链问题 */ -}}
        {{- $encodedURL := $cover | replaceRE "^https?://" "" -}}
        {{- $coverURL = printf "https://images.weserv.nl/?url=%s&w=300&h=200&fit=cover" $encodedURL -}}
    {{- else -}}
        {{- /* 本地图片：直接使用相对路径 */ -}}
        {{- $coverURL = $cover | relURL -}}
    {{- end -}}
{{- end -}}

<div class="post-link-card-wrap">
	<div class="post-link-card">
		<a
			href="{{ $href }}"
			title="{{ $title }}"
			{{- if $isExternal -}} rel="noopener nofollow noreferrer" target="_blank"{{- end -}}
		></a>
		{{- if eq $cover "auto" -}}
			{{- if $isExternal -}}
				<div class="post-link-card-cover-wrap auto">
					<div class="icon-globe"></div>
				</div>
			{{- else -}}
				<div class="post-link-card-cover-wrap">
					<img
						src="{{ .Site.Params.banner | relURL }}"
						class="no-lightbox"
						title="{{ $title }}"
						alt="{{ $altText }}"
					/>
				</div>
			{{- end -}}
		{{- else if $cover -}}
			<div class="post-link-card-cover-wrap">
				<img
					src="{{ $coverURL }}"
					class="no-lightbox"
					title="{{ $title }}"
					alt="{{ $altText }}"
					loading="lazy"
					{{- /* 加载失败时，显示本地占位图 */ -}}
					onerror="this.onerror=null; this.src='{{ $fallbackCover }}';"
				/>
			</div>
		{{- end -}}
		<div class="post-link-card-item-wrap">
			<div class="post-link-card-title">{{ $displayTitle }}</div>
			<div class="post-link-card-excerpt">
				{{- $excerpt -}}
			</div>
		</div>
	</div>
</div>